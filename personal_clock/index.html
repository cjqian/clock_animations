<!DOCTYPE html>
<meta charset="utf-8">
<head>
	<style>
		body{
			background-color:black;
			color:white;
			height: 720px;
			width:1280px;
		}

		#bezel
		{
			position: absolute;
			top: 100px;
			left: 400px;
		}

		/* Canvas dimension: 312 * 390 */
		#canvas-1{
			position: absolute;
			top: 210px;
			left: 510px;
			height: 410px;
			width: 332px;
			background-color: black;
		}

		#text-div{
			font-family: 'SF Display';
			font-size: 30px;
			position: absolute;
			top: 210px;
			left: 510px;
			height: 410px;
			width: 332px;
			padding:10px;
			text-align:right;
		}
	</style>

	<link rel="stylesheet" type="text/css" href="../jquery-ui.css"></style>
	<script type="text/javascript" src="../paper-full.js"></script>
	<script type="text/javascript" src="../jquery.js"></script>
	<script type="text/javascript" src="../jquery-ui.js"></script>



</head>

<body>


	<script type="text/paperscript" canvas="canvas-1">
/************************************************
 * Helper functions
 ***********************************************/

function growToSize(instance, targetLength, targetAngle, targetIdx)
{
	var length = instance.path.segments.length;

	if (instance.path.segments.length >= targetLength)
	{
	rotateToAngle(instance, targetAngle, targetIdx);
	return;
	}

	instance.offset++;
	instance.count--;

	var angle = instance.count * 5;
	var length = angle / 150;

	var vector = new paper.Point({
		angle: angle,
		length: length
	});

	vector.y = vector.y * -1;

	var rot= vector.rotate(90);
	rot.length = 2;
	instance.path.add(instance.position  - vector + rot);
	instance.path.insert(0, instance.position + vector - rot);
	instance.path.smooth();

	instance.position += vector;

	setTimeout(function() { return growToSize(instance, targetLength, targetAngle, targetIdx); }, fastInterval);
}

var fastInterval = .0001;

function grow(instance) {
	if (instance.count < 0 || instance.offset > instance.end) return;

	instance.offset++;
	instance.count--;

	var angle = instance.count * 5;
	var length = angle / 150;

	var vector = new paper.Point({
		angle: angle,
		length: length
	});

	vector.y = vector.y * -1;

	if (instance.offset > instance.begin && instance.offset < instance.end)
	{
		var rot= vector.rotate(90);
		rot.length = 2;
		instance.path.add(instance.position  - vector + rot);
		instance.path.insert(0, instance.position + vector - rot);
		instance.path.smooth();
	}

	instance.position += vector;

	if (instance.offset < instance.end)
	{
		if (instance.offset > instance.begin)
			setTimeout(function() { return grow(instance); }, interval);
		else
			setTimeout(function() { return grow(instance); }, fastInterval);
	} 
}

 function shrinkToSize(instance, targetLength, targetAngle, targetIdx)
{
	var length = instance.path.segments.length;
	if (length <= targetLength)
	{
	rotateToAngle(instance, targetAngle, targetIdx);
	return;
	}
	instance.path.removeSegment(length - 1);
	instance.path.removeSegment(0);
	setTimeout(function() { return shrinkToSize(instance, targetLength, targetAngle, targetIdx); }, fastInterval);
}

function deleteSpiral(instance) {
	instance.path.removeSegments(0, instance.path.segments.length);
}

function rotateToAngle(instance, rotation, showAtEnd)
{
	if (rotation == 0){
	/*
		sequenceArray[showAtEnd].path = instance.path.clone();
		instance.path.visible = false;
		deleteSpiral(instance);
		sequenceArray[showAtEnd].path.visible = true;
		*/
		return;
	}

	if (rotation < 1)
	{
		instance.path.rotate(-1);
		setTimeout(function() { return rotateToAngle(instance, rotation + 1, showAtEnd)}, fastInterval);
	}
	else{
		instance.path.rotate(1);
		setTimeout(function() { return rotateToAngle(instance, rotation - 1, showAtEnd)}, fastInterval);	
	}
}

function clearLayer()
{
for (var i = 0; i < paper.project.activeLayer.children.length; i++)
{
paper.project.activeLayer.children[i].visible = false;
}
}
function transitionInstances(currentIdx, targetIdx)
{
console.log("Transition" + currentIdx + " " + targetIdx);
console.log(sequenceArray);
clearLayer();

	var tmp = jQuery.extend(true, {}, sequenceArray[currentIdx]);
	tmp.path.visible = true;
	// Change the length of the path
	desiredLength = sequenceArray[targetIdx].path.segments.length;
	desiredAngle = (sequenceArray[targetIdx].begin - tmp.begin) * 5;

	if (tmp.path.segments.length > desiredLength)
	{
		shrinkToSize(tmp, desiredLength, desiredAngle, targetIdx);
	}

	if (tmp.path.segments.length < desiredLength)
	{
		growToSize(tmp, desiredLength, desiredAngle, targetIdx);
	}

	// Rotate the copy to match the start
	rotateToAngle(tmp, (sequenceArray[targetIdx].begin - tmp.begin) * 5, targetIdx);
}



// Returns a clean path in our desired style
function GetNewPath()
{
	var spiralPath = new paper.Path(
	{
		fillColor: 'white',
		strokeWidth: 100
	});

	spiralPath.strokeWidth = 1000;
	return spiralPath;
}

// Creates a new time with randomized start and endpoints
function CreateInstance()
{
	var beginOffset = parseInt(Math.random() * 80);
	var endOffset = parseInt(beginOffset + 48 + (Math.random() * 100));
	var currentPosition = new paper.Point(width / 2, height * 1 / 4);

	var instance = 
	{
		path: GetNewPath(), 
		begin: beginOffset,
		end: endOffset,
		position: currentPosition,
		offset: 0,
		count: 288
	};

	return instance;
}

// Initialization
var sequenceArray = [];
var sequenceIdx = -1;

var width = 312;
var height = 390;

var centerPosition = new paper.Point(width / 2, height / 2);

var initialInterval = 150;
var interval = initialInterval;

// Main area
var globalInstance = null;

/********************************************************************************
 * Keyboard functions
 **********************************************************************/
function handleScrollUp()
{
console.log("Up called with " + sequenceIdx);
	if (sequenceIdx <= 0) return;

	var difference = sequenceArray.length - sequenceIdx;
	// 1 sequence ago
	if (difference == 1)
	{
		$('#text-div').text("1 sequence ago");
	} 
	else 
	{
		$('#text-div').text(difference + " sequences ago");
	}

	sequenceIdx--;
	transitionInstances(sequenceIdx + 1, sequenceIdx);
}

function handleScrollDown()
{
console.log("Called down with " + sequenceIdx);
	if (sequenceIdx >= sequenceArray.length - 1) return;
	sequenceIdx++;
	console.log("lnegth " + sequenceArray.length);
	var difference = sequenceArray.length - sequenceIdx - 1;
	// 1 sequence ago
	if (difference == 0)
	{
		$('#text-div').text("");
	} 
	else if (difference == 1)
	{
		$('#text-div').text("1 sequence ago");
	}
	else 
	{
		$('#text-div').text(difference + " sequences ago");
	}

	transitionInstances(sequenceIdx - 1, sequenceIdx);
}


$(document).keypress(function(e) {
// w, up arrow
console.log(e.keyCode);

// Speed setting 1; very slow.

if (e.keyCode == 49)
{
interval = 150;
}

if (e.keyCode == 50)
{
interval = 10;
}

if (e.keyCode == 51)
{
interval = .00000001;
}

if (e.keyCode == 119)
{
	handleScrollUp();
}

if (e.keyCode == 115)
{
	handleScrollDown();
}

if (e.keyCode == 32)
{
	handleKeyPress();
}

// Generate new day
if (e.keyCode == 13)
{
	$('#text-div').text("");
clearLayer();
	if (globalInstance != null) globalInstance.path.visible = false;
	globalInstance = CreateInstance();
	grow(globalInstance);
	sequenceArray.push(globalInstance);
	sequenceIdx = sequenceArray.length - 1;
	console.log(sequenceIdx);
}
});

</script>

<img id="bezel" src="../bezel.png">
<canvas id="canvas-1"></canvas>

<div id="text-div"></div>


</body>

</html>